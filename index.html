<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Survey Parkir</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  html, body{
  width:100%;
  max-width:100%;
  overflow-x:hidden;
}

:root{
  --bg:#1c1c1c;
  --card:#ffffff;
  --text:#ffffff;
  --muted:#bdbdbd;
  --accent:#ff7a18;
  --danger:#e53935;
  --radius:14px;
}

body{
  margin:0;
  padding:16px;
  font-family:system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
}

h1,h3{
  margin:0 0 10px;
}

.card{
  background:var(--card);
  color:#111;
  padding:16px;
  border-radius:16px;
  margin-bottom:16px;
  overflow:hidden;          /* üî¥ PENTING */
}




label{
  display:block;
  font-size:13px;
  color:#444;
  margin-top:10px;
}

input,
select{
  box-sizing:border-box;
  width:100%;
  max-width:100%;
  height:44px;
  padding:0 12px;
  border-radius:12px;
  border:1px solid #d0d0d0;
  font-size:15px;
  background:#f5f5f5;
  appearance:none;
  -webkit-appearance:none;
}

select{
  background-image:none;
}


button{
  width:100%;
  height:48px;
  margin-top:12px;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}

.btn-primary{
  background:var(--accent);
  color:#fff;
}

.btn-out{
  background:var(--danger);
  color:#fff;
  height:40px;
  font-size:14px;
}


table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  border-bottom:1px solid #ddd;
  padding:6px;
  text-align:center;
}

th{
  background:#f3f3f3;
}
.header{
  margin-bottom:16px;
}

.header h1{
  font-size:22px;
  font-weight:700;
  margin:0;
  color:#fff;
}

/* rapikan card form */
.card + .card{
  margin-top:12px;
}

/* kecilkan tombol agar tidak ‚Äúnabrak‚Äù */
button{
  width:100%;
  height:44px;
  border-radius:12px;
}


/* pisahkan tombol */
.card button + button{
  margin-top:8px;
}

/* section title */
.section-title{
  margin:20px 0 8px;
  font-size:18px;
  font-weight:600;
  color:#fff;
}

/* tabel mobile friendly */
table{
  font-size:12px;
}

th, td{
  padding:8px 4px;
}

/* biar tabel tidak terlalu mepet */
.card table{
  margin-top:6px;
}
.app-credit{
  position:fixed;
  bottom:6px;
  right:10px;
  font-size:11px;
  color:rgba(255,255,255,0.45);
  pointer-events:none;
  user-select:none;
}
header .subtitle{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}
.flow-bar{
  display:flex;
  gap:10px;
  align-items:center;
  padding:12px;
  background:#141414;
  border-radius:14px;
  margin-bottom:8px;
}

/* dropdown */
.flow-select{
  width:65%;
}

  /* 35% untuk tombol */
.flow-actions{
  flex:1;
  display:flex;
  gap:8px;
}
.flow-select select{
  width:100%;
  height:42px;
  box-sizing:border-box;
  background:#2b2b2b;
  color:#fff;
  border:1px solid #444;
  border-radius:12px;
  font-weight:600;
  padding:0 14px;
}




/* tombol arus */
.flow-actions .flow-btn{
  flex:1;
  min-width:0;
  height:42px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  font-weight:700;
}



/* MASUK = ORANGE */
.flow-btn.masuk{
  background:#ff7a18;
}

/* KELUAR = MERAH GELAP */
.flow-btn.keluar{
  background:#e53935;
}

.flow-btn.kl{
  background:#607d8b;
  color:#fff;
}

.flow-result{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:#fff;
  padding:0 4px 10px;
}


  
</style>

</head>

<body>
 

  <script>
function hashPin(pin){
  return btoa(pin + "_salt");
}


</script>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyIp0gOox232fz1_7AzQSJGyGQutxitScJt-kA5zpXoIDwI3cvDnVCcp7GUNPVFanrb/exec";
const ACCESS_PIN = "111"; //GANTI PIN
const LOGIN_KEY  = "parkir_login_hash";

const ARUS_KL_KEY = "arusKL";
const CURRENT_PIN_HASH = hashPin(ACCESS_PIN);
const ARUS_MASUK_KEY  = "arusMasuk";
const ARUS_KELUAR_KEY = "arusKeluar";
  let pressTimer = null;
let isLongPress = false;
const LONG_PRESS_MS = 800;
function setupLongPress(button, onClick, onLongPress){
  button.addEventListener("mousedown", start);
  button.addEventListener("touchstart", start);

  button.addEventListener("mouseup", end);
  button.addEventListener("mouseleave", end);
  button.addEventListener("touchend", end);
  button.addEventListener("touchcancel", end);

  function start(e){
  // Check if the event is cancelable before preventing its default action.
  // This helps avoid the browser intervention message.
  if (e.cancelable) {
    e.preventDefault();
  }

  isLongPress = false;

  pressTimer = setTimeout(() => {
    isLongPress = true;
    onLongPress();
    vibrate();
  }, LONG_PRESS_MS);
}

  function end(){
    clearTimeout(pressTimer);
    if (!isLongPress) {
      onClick();
    }
  }
}
const QUEUE_KEY = "offlineQueue";
let isFlushing = false;

function queueData(payload){
  const q = JSON.parse(localStorage.getItem(QUEUE_KEY)) || [];
  q.push(payload);
  localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
}

function sendOrQueue(payload){
  if (!navigator.onLine) {
    queueData(payload);
    return;
  }

  fetch(SHEET_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).catch(() => {
    queueData(payload);
  });
}

async function flushQueue(){
  if (isFlushing) return;
  isFlushing = true;

  const q = JSON.parse(localStorage.getItem(QUEUE_KEY)) || [];
  if (!q.length) {
    isFlushing = false;
    return;
  }

  const info = document.getElementById("syncInfo");
  if (info) info.style.display = "block";

  const sisa = [];

  for (const payload of q) {
  try {
    await Promise.race([
      fetch(SHEET_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }),
      new Promise((_, reject) =>
        setTimeout(() => reject(), 5000)
      )
    ]);
  } catch {
    sisa.push(payload);
  }
}


  localStorage.setItem(QUEUE_KEY, JSON.stringify(sisa));

  if (info) info.style.display = "none";
  isFlushing = false;
}




window.addEventListener("online", () => {
  if (document.readyState === "complete") {
    flushQueue();
  } else {
    window.addEventListener("DOMContentLoaded", flushQueue, { once:true });
  }
});


function vibrate(){
  if (navigator.vibrate) {
    navigator.vibrate(40);
  }
}
document.addEventListener("DOMContentLoaded", () => {

  const btnMasuk  = document.getElementById("btnMasuk");
  const btnKeluar = document.getElementById("btnKeluar");
  const btnKL     = document.getElementById("btnKL");
  

  // tombol MASUK / KELUAR
  if (btnMasuk && btnKeluar) {
    setupLongPress(
      btnMasuk,
      () => tambahArus("MASUK", +1),
      () => tambahArus("MASUK", -1)
    );

    setupLongPress(
      btnKeluar,
      () => tambahArus("KELUAR", +1),
      () => tambahArus("KELUAR", -1)
    );
  }
if (localStorage.getItem(LOGIN_KEY) === CURRENT_PIN_HASH) {
  showApp();
} else {
  askPin();
}

  // tombol KL
  if (btnKL) {
    setupLongPress(
      btnKL,
      () => tambahKL(+1),
      () => tambahKL(-1)
    );
  }

});

function kirimKendaraanLambat(status){
  sendOrQueue({
    mode: "KL",
    waktu: new Date().toLocaleString("id-ID"),
    jenis: document.getElementById("flowJenis").value,
    status,
    surveyor: localStorage.getItem("namaSurveyor") || ""
  });
}









function tambahArus(arah, nilai){
  const jenis = document.getElementById("flowJenis").value;

  if (arah === "MASUK") {
    arusMasukCounter[jenis] = Math.max(0, arusMasukCounter[jenis] + nilai);
  } else {
    arusKeluarCounter[jenis] = Math.max(0, arusKeluarCounter[jenis] + nilai);
  }

  simpanArus();
  updateArusText();   // ‚¨ÖÔ∏è INI YANG KURANG

  kirimArus(arah, nilai > 0 ? "ADD" : "CANCEL");
}


function askPin(){
  const input = prompt("Masukkan PIN Akses");
  if (input === null) return;

  if (input.trim() === ACCESS_PIN) {
    localStorage.setItem(LOGIN_KEY, CURRENT_PIN_HASH);
    showApp();
    return;
  }

  alert("PIN salah");
  location.reload(); // ‚¨ÖÔ∏è PENTING
}





  
function showApp(){
  document.getElementById("app").style.display = "block";
  updateArusText(); // ‚úÖ SATU-SATUNYA TEMPAT BOLEH PANGGIL
}






  
</script>





<div id="app" style="display:none">

  <div class="header">
  <h1>Survey Parkir</h1>
  <div class="subtitle">Kelas E</div>
</div>
<div class="card">
    <label>Nama Surveyor</label>
  <input id="surveyor" placeholder="Nama surveyor">
  <label>Jenis Kendaraan</label>
  <select id="jenis">
  <option value="SM">SM ‚Äì Sepeda Motor</option>
  <option value="MP">MP ‚Äì Mobil Penumpang</option>
  <option value="KS">KS ‚Äì Kendaraan Sedang</option>
  <option value="BB">BB ‚Äì Bus Besar</option>
  <option value="TB">TB ‚Äì Truk Besar</option>
  <option value="KTB">KTB ‚Äì Kendaraan Tidak Bermotor</option>
</select>



  <label>Ciri-ciri Kendaraan (opsional)</label>
  <input id="plat" placeholder="warna, tipe, muatan, dll">

  <button class="btn-primary" onclick="parkirMasuk()">‚ûï Masuk Parkir</button>
  <button class="btn-out" onclick="resetData()">‚ü≤ Reset Data</button>


</div>
  
<div class="flow-bar">
  <div class="flow-select">
    <select id="flowJenis">
  <option value="SM">SM</option>
  <option value="MP">MP</option>
  <option value="KS">KS</option>
  <option value="BB">BB</option>
  <option value="TB">TB</option>
  <option value="KTB">KTB</option>
</select>

  </div>

 <div class="flow-actions">
  <button class="flow-btn masuk" id="btnMasuk">MASUK</button>
  <button class="flow-btn keluar" id="btnKeluar">KELUAR</button>
  <button class="flow-btn kl" id="btnKL">KL</button>
</div>
</div>


<div id="arusWrapper" style="
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:#ccc;
  padding:4px 6px 10px;
">
  <div id="arusMasukText"></div>

  <div id="arusKLText" style="text-align:center;color:#90caf9">
    KL: SM 0 | MP 0 | KS 0 | BB 0 | TB 0 | KTB 0
  </div>

  <div id="arusKeluarText"></div>
</div>

</div>
<div class="card">
  <input
    id="searchInput"
    placeholder="Cari jenis / ciri / waktu masuk (contoh: SM, merah, 18.22)"
    oninput="filterParkir()"
    style="
      background:#f5f5f5;
      border:1px solid #ccc;
      border-radius:12px;
      height:44px;
      font-size:14px;
    "
  >
</div>



<div class="card">
  <div class="section-title">Sedang Parkir</div>

  <table>
    <thead>
  <tr>
    <th>ID</th>
    <th>Jenis</th>
    <th>Ciri</th>   <!-- ‚¨ÖÔ∏è TAMBAHKAN DI SINI -->
    <th>Masuk</th>
    <th>Aksi</th>
  </tr>
</thead>

    <tbody id="aktif"></tbody>
  </table>
</div>

<div class="card">
  <div class="section-title">Selesai Parkir</div>

  <table>
    <thead>
  <tr>
    <th>ID</th>
    <th>Jenis</th>
    <th>Ciri</th>   <!-- ‚¨ÖÔ∏è TAMBAHKAN DI SINI -->
    <th>Masuk</th>
    <th>Aksi</th>
  </tr>
</thead>

    <tbody id="selesai"></tbody>
  </table>
</div>


<script>


const DEFAULT_ARUS = { SM:0, MP:0, KS:0, BB:0, TB:0, KTB:0 };

let arusMasukCounter =
  JSON.parse(localStorage.getItem(ARUS_MASUK_KEY)) || {};

let arusKeluarCounter =
  JSON.parse(localStorage.getItem(ARUS_KELUAR_KEY)) || {};

let arusKLCounter =
  JSON.parse(localStorage.getItem(ARUS_KL_KEY)) || {};

// normalisasi
arusMasukCounter  = { ...DEFAULT_ARUS, ...arusMasukCounter };
arusKeluarCounter = { ...DEFAULT_ARUS, ...arusKeluarCounter };
arusKLCounter     = { ...DEFAULT_ARUS, ...arusKLCounter };

simpanArus();
simpanKL();








let aktif = JSON.parse(localStorage.getItem("parkirAktif")) || [];
let selesai = JSON.parse(localStorage.getItem("parkirSelesai")) || [];
let idCounter = Number(localStorage.getItem("parkirID")) || 1;
const surveyorInput = document.getElementById("surveyor");

if (surveyorInput) {
  // load saat buka
  surveyorInput.value =
    localStorage.getItem("namaSurveyor") || "";

  // simpan saat diketik
  surveyorInput.addEventListener("input", () => {
    localStorage.setItem(
      "namaSurveyor",
      surveyorInput.value
    );
  });
}


function waktu(){
  return new Date().toLocaleTimeString("id-ID");
}

function simpan(){
  localStorage.setItem("parkirAktif", JSON.stringify(aktif));
  localStorage.setItem("parkirSelesai", JSON.stringify(selesai));
  localStorage.setItem("parkirID", idCounter);
}
function resetArus(){
  arusMasukCounter  = { SM:0, MP:0, KS:0, BB:0, TB:0, KTB:0 };
  arusKeluarCounter = { SM:0, MP:0, KS:0, BB:0, TB:0, KTB:0 };
  arusKLCounter     = { SM:0, MP:0, KS:0, BB:0, TB:0, KTB:0 };

  localStorage.removeItem(ARUS_MASUK_KEY);
  localStorage.removeItem(ARUS_KELUAR_KEY);
  localStorage.removeItem(ARUS_KL_KEY);

  simpanArus();
  simpanKL();
  updateArusText();
}



function simpanArus(){
  localStorage.setItem(ARUS_MASUK_KEY, JSON.stringify(arusMasukCounter));
  localStorage.setItem(ARUS_KELUAR_KEY, JSON.stringify(arusKeluarCounter));
}
function simpanKL(){
  localStorage.setItem(ARUS_KL_KEY, JSON.stringify(arusKLCounter));
}

function resetData(){
  if(!confirm("mau reset SEMUA data parkir & arus?")){
    return;
  }

  // reset parkir
  aktif = [];
  selesai = [];
  idCounter = 1;

  localStorage.removeItem("parkirAktif");
  localStorage.removeItem("parkirSelesai");
  localStorage.removeItem("parkirID");

  // reset arus
  resetArus();

  render();
}


function tambahKL(nilai){
  const jenis = document.getElementById("flowJenis").value;

  arusKLCounter[jenis] =
    Math.max(0, arusKLCounter[jenis] + nilai);

  simpanKL();
  updateArusText();

  // kirim ke sheet (ADD / CANCEL)
  kirimKendaraanLambat(
    nilai > 0 ? "ADD" : "CANCEL"
  );
}


  



function parkirMasuk(){
  aktif.push({
    id: idCounter++,
    jenis: jenis.value,
    plat: plat.value,
    masuk: new Date()
  });
  plat.value="";
  simpan();
  render();
}

function parkirKeluar(id){
  let i = aktif.findIndex(x=>x.id===id);
  let data = aktif.splice(i,1)[0];
  let keluar = new Date();
  let durasi = Math.round((keluar - data.masuk)/60000);

  sendOrQueue({
    mode: "PARKIR",
    surveyor: localStorage.getItem("namaSurveyor") || "",
    jenis: data.jenis,
    ciri: data.plat || "",
    masuk: new Date(data.masuk).toLocaleString("id-ID"),
    keluar: keluar.toLocaleString("id-ID"),
    durasi
  });

  selesai.push({...data, keluar, durasi});
  simpan();
  render();
}


  

function filterParkir(){
  const q = document.getElementById("searchInput").value
    .toLowerCase()
    .trim();

  if(!q){
    render();
    return;
  }

  const hasil = aktif.filter(d => {
    const jenis = d.jenis.toLowerCase();
    const ciri  = (d.plat || "").toLowerCase();
    const waktu = new Date(d.masuk)
      .toLocaleTimeString("id-ID")
      .toLowerCase();

    return (
      jenis.includes(q) ||
      ciri.includes(q)  ||
      waktu.includes(q)
    );
  });

  renderFiltered(hasil);
}



function render(){
  aktifEl.innerHTML = "";
  selesaiEl.innerHTML = "";

  aktif.forEach(d=>{
    aktifEl.innerHTML += `
      <tr>
        <td>${d.id}</td>
        <td>${d.jenis}</td>
        <td>${d.plat || "-"}</td>
        <td>${new Date(d.masuk).toLocaleTimeString("id-ID")}</td>
        <td>
          <button class="btn-out" onclick="parkirKeluar(${d.id})">
            Keluar
          </button>
        </td>
      </tr>
    `;
  });

  selesai.forEach(d=>{
    selesaiEl.innerHTML += `
      <tr>
        <td>${d.id}</td>
        <td>${d.jenis}</td>
        <td>${d.plat || "-"}</td>
        <td>${new Date(d.masuk).toLocaleTimeString("id-ID")}</td>
        <td>${new Date(d.keluar).toLocaleTimeString("id-ID")}</td>
        <td>${d.durasi}</td>
      </tr>
    `;
  });
}

function renderFiltered(data){
  aktifEl.innerHTML = "";

  data.forEach(d=>{
    aktifEl.innerHTML += `
      <tr>
        <td>${d.id}</td>
        <td>${d.jenis}</td>
        <td>${d.plat || "-"}</td>
        <td>${new Date(d.masuk).toLocaleTimeString("id-ID")}</td>
        <td>
          <button class="btn-out" onclick="parkirKeluar(${d.id})">
            Keluar
          </button>
        </td>
      </tr>
    `;
  });
}


  

const aktifEl = document.getElementById("aktif");
const selesaiEl = document.getElementById("selesai");

render();
</script>
  </div> <!-- end #app -->

<div class="app-credit">
  WEB created by N4yr4
</div>
<script>



function updateArusText(){
  document.getElementById("arusMasukText").innerText =
    `MASUK ‚Üí SM ${arusMasukCounter.SM} | MP ${arusMasukCounter.MP} | KS ${arusMasukCounter.KS} | BB ${arusMasukCounter.BB} | TB ${arusMasukCounter.TB} | KTB ${arusMasukCounter.KTB}`;

  document.getElementById("arusKLText").innerText =
    `KL ‚Üí SM ${arusKLCounter.SM} | MP ${arusKLCounter.MP} | KS ${arusKLCounter.KS} | BB ${arusKLCounter.BB} | TB ${arusKLCounter.TB} | KTB ${arusKLCounter.KTB}`;

  document.getElementById("arusKeluarText").innerText =
    `KELUAR ‚Üí SM ${arusKeluarCounter.SM} | MP ${arusKeluarCounter.MP} | KS ${arusKeluarCounter.KS} | BB ${arusKeluarCounter.BB} | TB ${arusKeluarCounter.TB} | KTB ${arusKeluarCounter.KTB}`;
}






function kirimArus(arah, status){
  sendOrQueue({
    mode: "ARUS",
    waktu: new Date().toLocaleString("id-ID"),
    jenis: document.getElementById("flowJenis").value,
    arah,
    status,
    surveyor: localStorage.getItem("namaSurveyor") || ""
  });
}








document.addEventListener("DOMContentLoaded", () => {
  const netStatus = document.getElementById("netStatus");

  function updateNetworkStatus(){
    netStatus.style.display = navigator.onLine ? "none" : "block";
  }

  updateNetworkStatus();

  window.addEventListener("online", updateNetworkStatus);
  window.addEventListener("offline", updateNetworkStatus);
});




</script>

<div id="netStatus" style="
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:#e53935;
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  display:none;
  z-index:9999;
">
  ‚ùå Tidak ada koneksi internet
</div>
<div id="syncInfo" style="
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  font-size:11px;
  color:#90caf9;
  display:none;
">
  ‚è≥ Mengirim data tersimpan...
</div>

</body>
</html>
